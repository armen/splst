<!DOCTYPE html>
<html>
    {{template "head"}}
    <body>
        <div class="container">
            <div class="row">
                {{template "header"}}
            </div>
            <div class="row">
                <div id="add-project-container" style="display:none;">
                    <div id="upload-message" class="alert alert-success" style="display:none;">
                        <h4>Woot!</h4>
                        <p>Successfully created the project.</p>
                    </div>
                    <div id="error-block" class="alert alert-error" style="display:none;">
                        <button type="button" class="close" data-dismiss="alert">Ã—</button>
                        <h4>Oops!</h4>
                        <p id="error-message"></p>
                    </div>
                    <form class="form-horizontal" id="add-project">
                        <div id="url-group" class="control-group">
                            <label class="control-label" for="url">Project URL</label>
                            <div class="controls">
                                <input type="text" name="url" id="url" placeholder="Project URL" class="input-xxlarge">
                                <span class="help-inline">Must be a fully qualified URL that includes <b>http://</b> or <b>https://</b></span>
                            </div>
                        </div>
                        <div id="name-group" class="second-stage control-group" style="display:none;">
                            <label class="control-label" for="name">Project Name</label>
                            <div class="controls">
                                <input type="text" name="name" id="name" placeholder="Project Name" class="input-xxlarge">
                                <span class="help-inline"></span>
                            </div>
                        </div>
                        <div id="description-group" class="second-stage control-group" style="display:none;">
                            <label class="control-label" for="description">Description</label>
                            <div class="controls">
                                <textarea name="description" id="description" rows="2" class="input-xxlarge"></textarea>
                            </div>
                        </div>
                        <div id="code-repo-group" class="second-stage control-group" style="display:none;">
                            <label class="control-label" for="code-repo">Code Repository</label>
                            <div class="controls">
                                <input type="text" name="code-repo" id="code-repo" class="input-xlarge">
                            </div>
                        </div>
                        <div class="controls">
                            <button type="button" class="btn btn-success" id="fetch">Fetch</button>
                            <button type="submit" class="btn btn-success" id="add" style="display:none;">Add</button>
                            <button type="button" class="btn add-project">Close</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row">
                <ul id="projects" class="thumbnails" style="position: relative;">
                {{range .projects}}
                    <li class="span4">
                        <div class="thumbnail">
                            <div class="caption"><b>{{.Name}}</b></div>
                            {{if .Thumb}}<img src="static/projects/{{.OwnerId}}/{{.Id}}/small.jpg" />{{end}}
                            <div class="caption">
                                <a href="{{.URL}}">{{.URL | printf "%.45s"}}</a>
                                {{if .RepositoryURL}}<a href="{{.URL}}">{{.RepositoryURL | printf "%.45s"}}</a>{{end}}
                                {{if .Description}}<p>{{.Description | printf "%.200s"}}</p>{{end}}
                            </div>
                        </div>
                    </li>
                {{end}}
                </ul>
            </div>
        </div>
        <script src="static/js/min/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="static/js/min/jquery.wookmark.min.js"></script>
        <script type="text/javascript">
            $(function() {
                $('#projects li').wookmark({container: $('#projects'), autoResize: true});

                $('.close').click(function() {
                    $(this).parent().fadeOut("fast");
                });

                $('.add-project').click(function() {
                    if ($('#add-project-container').is(':hidden')) {
                        $('#add-project-container').slideDown('fast');
                    } else {
                        $('#add-project-container').slideUp('fast');
                    }

                    if ($('#fetch').is(':hidden')) {
                        $('#name').focus();
                    } else {
                        $('#url').focus();
                    }
                });

                var _cache = {};

                $('#url').bind('focusout', function () {

                    url = $.trim($(this).val())

                    if (url == '') {
                        return false;
                    }

                    if (url.substr(0, 7) != 'http://' && url.substr(0, 8) != 'https://') {
                        url = 'http://' + url;
                        $(this).val(url);
                    }

                    $('#add-project-link').addClass("loading");
                    $("#url").attr("disabled", "disabled");
                    $('.second-stage ').slideUp('fast');
                    $('#fetch').show();
                    $('#add').hide();
                    $('#name').focus();

                    $.ajax({
                        url: "fetch-url-info",
                        data: {url: url},
                        type: "POST",
                        dataType: 'json',
                        accepts: {
                            json: 'application/json'
                        }
                    }).always(function(result) {
                        $.each(_cache, function(field, inline_help) {
                            group = $("#"+field+"-group");
                            group.removeClass("error");
                            $(".help-inline", group).text(inline_help);
                        });
                        // clear the cache
                        _cache = {};

                        return false;

                    }).fail(function(result) {

                        $("#add-project-link").removeClass("loading");

                        url = $('#url').val();
                        $("#add-project").find('input:text, textarea').val('');
                        $('#url').removeAttr("disabled").val(url);

                        group = $('#url-group').addClass("error");
                        _cache['url'] = $(".help-inline", group).text();
                        $(".help-inline", group).text('Could not fetch the url');
                        $('#url').focus();

                        $('button[type="submit"]', $("#add-project")).removeAttr("disabled");

                    }).success(function(result) {

                        $("#add-project-link").removeClass("loading");

                        url = $('#url').val();
                        $("#add-project").find('input:text, textarea').val('');
                        $('#url').removeAttr("disabled").val(url);

                        $.each(result, function(field, value) {
                            $('#'+field).val(value);
                        });
                        $('.second-stage').slideDown('fast');
                        $('#fetch').hide();
                        $('#add').show();

                        $('button[type="submit"]', $("#add-project")).removeAttr("disabled");
                    });
                });

                $('#add-project').submit(function() {

                    $('button[type="submit"]', $(this)).attr("disabled", "disabled");
                    $('#add-project-link').addClass("loading");
                    $('#error-block').fadeOut("slow");

                    $.ajax({
                        url: "add-project",
                        data: $(this).serializeArray(),
                        type: "POST",
                        dataType: 'json',
                        accepts: {
                            json: 'application/json'
                        }
                    }).always(function(result) {
                        $.each(_cache, function(field, inline_help) {
                            group = $("#"+field+"-group");
                            group.removeClass("error");
                            $(".help-inline", group).text(inline_help);
                        });
                        // clear the cache
                        _cache = {};

                        return false;

                    }).fail(function(result) {

                        $("#add-project-link").removeClass("loading");

                        if (result.getResponseHeader("Content-Type") == "application/json") {
                            errMessage = $.parseJSON(result.responseText);
                            $.each(errMessage, function(field, error) {

                                if (field == "error") {
                                    $("#error-message").text(error);
                                    $("#error-block").fadeIn("fast");
                                } else {
                                    group = $("#"+field+"-group");
                                    // save inline help message in the cache
                                    _cache[field] = $(".help-inline", group).text();
                                    group.addClass("error");
                                    $(".help-inline", group).text(error);
                                }
                            });
                        }

                        $('button[type="submit"]', $("#add-project")).removeAttr("disabled");

                    }).success(function(result) {

                        $("#add-project-link").removeClass("loading");

                        $('#upload-message').fadeToggle("slow");
                        setTimeout(function() {
                            $('#upload-message').fadeToggle("slow");
                            setTimeout(function() {
                                $('#add-project-container').slideUp('fast');
                                setTimeout(function() {
                                    // We need to clear text input
                                    // $("#add-form").find('input:text, input:password, input:file, select, textarea').val('');
                                    // $("#add-form").find('input:radio, input:checkbox').removeAttr('checked').removeAttr('selected');
                                    $("#add-project").find('input:text, textarea').val('');
                                    $('.second-stage').hide();
                                    $('button[type="submit"]', $("#add-project")).removeAttr("disabled");
                                }, 500);
                            }, 1500);
                        }, 3000);
                    });

                    return false;
                });
            });
        </script>
    </body>
</html>
