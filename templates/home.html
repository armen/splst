<!DOCTYPE html>
<html>
    {{template "head"}}
    <body>
        <div class="container">
            <div class="row">
                {{template "header"}}
            </div>
            <div class="row">
                <div id="add-project-container" style="display:none;">
                    <div id="upload-message" class="alert alert-success" style="display:none;">
                        <h4>Woot!</h4>
                        <p>Successfully created the project.</p>
                    </div>
                    <div id="error-block" class="alert alert-error" style="display:none;">
                        <button type="button" class="close" data-dismiss="alert">Ã—</button>
                        <h4>Oops!</h4>
                        <p id="error-message"></p>
                    </div>
                    <form class="form-horizontal" id="add-project">
                        <div id="project-name-group" class="control-group">
                            <label class="control-label" for="project-name">Project Name</label>
                            <div class="controls">
                                <input type="text" name="project-name" id="project-name" placeholder="Project Name">
                                <span class="help-inline"></span>
                            </div>
                        </div>
                        <div id="project-url-group" class="control-group">
                            <label class="control-label" for="project-url">Project URL</label>
                            <div class="controls">
                                <input type="text" name="project-url" id="project-url" placeholder="Project URL">
                                <span class="help-inline">Must be a fully qualified URL that includes <b>http://</b> or <b>https://</b></span>
                            </div>
                        </div>
                        <div class="controls">
                            <button type="submit" class="btn btn-success" id="add">Add</button>
                            <button type="button" class="btn add-project">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row">
                <ul id="to-upload-splsts" class="thumbnails" style="position: relative;"></ul>
            </div>
        </div>
        <script src="static/js/min/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="static/js/min/jquery.wookmark.min.js"></script>
        <script type="text/javascript">
            $(function() {
                $('#to-upload-splsts li').wookmark({container: $('#to-upload-splsts'), autoResize: true});
            });

            $(function() {

                $('.close').click(function() {
                    $(this).parent().fadeOut("fast");
                });

                $('.add-project').click(function() {
                    if ($('#add-project-container').is(':hidden')) {
                        $('#add-project-container').slideDown('fast');
                        $('#project-name').focus();
                    } else {
                        $('#add-project-container').slideUp('fast');
                    }
                });

                var _cache = {};

                $('#add-project').submit(function() {

                    $('#error-block').fadeOut("slow");
                    $.ajax({
                        url: "add-project",
                        data: $(this).serializeArray(),
                        type: "POST"
                    }).always(function(result) {
                        $.each(_cache, function(field, inline_help) {
                            group = $("#"+field+"-group");
                            group.removeClass("error");
                            $(".help-inline", group).text(inline_help);
                        });
                        // clear the cache
                        _cache = {};

                        return false;

                    }).fail(function(result) {
                        if (result.getResponseHeader("Content-Type") == "application/json") {
                            errMessage = $.parseJSON(result.responseText);
                            $.each(errMessage, function(field, error) {

                                if (field == "error") {
                                    $("#error-message").text(error);
                                    $("#error-block").fadeIn("fast");
                                } else {
                                    group = $("#"+field+"-group");
                                    // save inline help message in the cache
                                    _cache[field] = $(".help-inline", group).text();
                                    group.addClass("error");
                                    $(".help-inline", group).text(error);
                                }
                            });
                        }
                    }).success(function(result) {
                        $('#upload-message').fadeToggle("slow");
                        setTimeout(function() {
                            $('#upload-message').fadeToggle("slow");
                            setTimeout(function() {
                                $('#add-project-container').slideUp('fast');
                                setTimeout(function() {
                                    // We need to clear text input
                                    // $("#add-form").find('input:text, input:password, input:file, select, textarea').val('');
                                    // $("#add-form").find('input:radio, input:checkbox').removeAttr('checked').removeAttr('selected');
                                    $("#add-project").find('input:text').val('');
                                }, 500);
                            }, 1500);
                        }, 3000);
                    });

                    return false;
                });
            });
        </script>
    </body>
</html>
